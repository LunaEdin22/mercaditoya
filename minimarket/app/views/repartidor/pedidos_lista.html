<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos Asignados - MercaditoYa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .estado-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .card-stats {
            border-left: 4px solid #007bff;
        }
        .btn-entregar {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .btn-entregar:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="bi bi-shop"></i> MercaditoYa - Repartidor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('auth.logout') }}">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Mensajes Flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="bi bi-truck"></i> Mis Pedidos Asignados</h2>
                <p class="text-muted">Bienvenido {{ current_user.nombre_completo }}</p>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 class="text-primary">{{ stats.total }}</h3>
                                <p class="text-muted mb-0">Total Asignados</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-list-check fs-1 text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 class="text-warning">{{ stats.en_camino }}</h3>
                                <p class="text-muted mb-0">En Camino</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-truck fs-1 text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 class="text-success">{{ stats.entregados }}</h3>
                                <p class="text-muted mb-0">Entregados</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-check-circle fs-1 text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 class="text-danger">{{ stats.cancelados }}</h3>
                                <p class="text-muted mb-0">Cancelados</p>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-x-circle fs-1 text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Pedidos -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Mis Pedidos</h5>
            </div>
            <div class="card-body p-0">
                {% if pedidos %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Pedido #</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Dirección</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pedido in pedidos %}
                                <tr>
                                    <td><strong>#{{ pedido.id_pedido }}</strong></td>
                                    <td>
                                        <div>
                                            <strong>{{ pedido.usuario.nombre_completo }}</strong><br>
                                            <small class="text-muted">{{ pedido.usuario.email }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ pedido.fecha.strftime('%d/%m/%Y') }}</small><br>
                                        <small class="text-muted">{{ pedido.fecha.strftime('%H:%M') }}</small>
                                    </td>
                                    <td>
                                        <strong>S/. {{ "%.2f"|format(pedido.total) }}</strong>
                                    </td>
                                    <td>
                                        {% if pedido.es_delivery %}
                                            <span class="badge bg-info">
                                                <i class="bi bi-truck"></i> Delivery
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="bi bi-shop"></i> Retiro
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set estado_colors = {
                                            'pendiente': 'secondary',
                                            'confirmado': 'primary', 
                                            'en_preparacion': 'warning',
                                            'en_camino': 'info',
                                            'entregado': 'success',
                                            'cancelado': 'danger'
                                        } %}
                                        <span class="badge bg-{{ estado_colors.get(pedido.estado, 'secondary') }} estado-badge">
                                            {{ pedido.estado.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if pedido.es_delivery %}
                                            <small>{{ pedido.usuario.direccion or 'No especificada' }}</small>
                                        {% else %}
                                            <small class="text-muted">Retiro en tienda</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <!-- Botón para marcar como entregado -->
                                            {% if pedido.estado == 'en_camino' %}
                                                <button type="button" 
                                                        class="btn btn-entregar btn-sm btn-entregar-pedido"
                                                        data-pedido-id="{{ pedido.id_pedido }}"
                                                        title="Marcar como entregado">
                                                    <i class="bi bi-check-circle"></i> Entregar
                                                </button>
                                            {% elif pedido.estado == 'entregado' %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle"></i> Entregado
                                                </span>
                                            {% elif pedido.estado == 'cancelado' %}
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-x-circle"></i> Cancelado
                                                </span>
                                            {% else %}
                                                <small class="text-muted">Esperando...</small>
                                            {% endif %}
                                            
                                            <!-- Botón cancelar (solo para estados válidos) -->
                                            {% if pedido.estado in ['en_preparacion', 'en_camino'] %}
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm btn-cancelar-pedido"
                                                        data-pedido-id="{{ pedido.id_pedido }}"
                                                        title="Cancelar pedido">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            {% endif %}
                                            
                                            <!-- Botón ver detalles -->
                                            <button type="button" 
                                                    class="btn btn-outline-primary btn-sm btn-ver-detalle"
                                                    data-pedido-id="{{ pedido.id_pedido }}"
                                                    title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">No tienes pedidos asignados</h4>
                        <p class="text-muted">Los pedidos asignados aparecerán aquí</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal para confirmar entrega -->
    <div class="modal fade" id="modalConfirmarEntrega" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Confirmar Entrega
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-truck display-1 text-success"></i>
                    </div>
                    <h6 class="text-center">¿Confirmas que has entregado este pedido?</h6>
                    <p class="text-muted text-center mb-0">Esta acción no se puede deshacer</p>
                    <div id="infoPedidoEntrega" class="mt-3 p-3 bg-light rounded">
                        <!-- Información del pedido -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="btnConfirmarEntrega">
                        <i class="bi bi-check-circle"></i> Confirmar Entrega
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cancelar pedido -->
    <div class="modal fade" id="modalCancelarPedido" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Cancelar Pedido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-x-circle display-1 text-warning"></i>
                    </div>
                    <h6 class="text-center">¿Estás seguro de cancelar este pedido?</h6>
                    <p class="text-muted text-center">Esta acción restaurará el stock de productos</p>
                    
                    <div id="infoPedidoCancelacion" class="mt-3 p-3 bg-light rounded">
                        <!-- Información del pedido -->
                    </div>
                    
                    <div class="mt-3">
                        <label for="motivoCancelacion" class="form-label">
                            <strong>Motivo de cancelación <span class="text-danger">*</span></strong>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="motivoCancelacion" 
                            rows="3" 
                            placeholder="Explica por qué necesitas cancelar este pedido..."
                            required></textarea>
                        <div class="form-text">El motivo es obligatorio para repartidores</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left"></i> No Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnConfirmarCancelacion">
                        <i class="bi bi-x-circle"></i> Sí, Cancelar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para notificaciones -->
    <div class="modal fade" id="modalNotificacion" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" id="headerNotificacion">
                    <h5 class="modal-title" id="tituloNotificacion">
                        <i class="bi bi-info-circle"></i> Información
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i id="iconoNotificacion" class="display-1"></i>
                    </div>
                    <p id="mensajeNotificacion" class="text-center mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles del pedido -->
    <div class="modal fade" id="modalDetalle" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt"></i> Detalles del Pedido
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="contenidoDetalle">
                        <!-- Aquí se cargará el contenido -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Cerrar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnAbrirEnNuevaVentana" style="display: none;">
                        <i class="bi bi-box-arrow-up-right"></i> Abrir en nueva ventana
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let pedidoActualEntrega = null;
        let pedidoActualCancelacion = null;

        // Event listeners para botones
        document.addEventListener('DOMContentLoaded', function() {
            // Botones de entregar pedido
            document.querySelectorAll('.btn-entregar-pedido').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const idPedido = this.getAttribute('data-pedido-id');
                    mostrarModalConfirmacion(idPedido);
                });
            });
            
            // Botones de cancelar pedido
            document.querySelectorAll('.btn-cancelar-pedido').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const idPedido = this.getAttribute('data-pedido-id');
                    mostrarModalCancelacion(idPedido);
                });
            });
            
            // Botones de ver detalle
            document.querySelectorAll('.btn-ver-detalle').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const idPedido = this.getAttribute('data-pedido-id');
                    verDetalle(idPedido);
                });
            });

            // Botón de confirmar entrega en el modal
            document.getElementById('btnConfirmarEntrega').addEventListener('click', function() {
                if (pedidoActualEntrega) {
                    entregarPedido(pedidoActualEntrega);
                }
            });

            // Botón de confirmar cancelación en el modal
            document.getElementById('btnConfirmarCancelacion').addEventListener('click', function() {
                if (pedidoActualCancelacion) {
                    const motivo = document.getElementById('motivoCancelacion').value.trim();
                    if (!motivo) {
                        alert('Debes proporcionar un motivo para la cancelación');
                        return;
                    }
                    cancelarPedido(pedidoActualCancelacion, motivo);
                }
            });
        });

        function mostrarModalConfirmacion(idPedido) {
            pedidoActualEntrega = idPedido;
            
            // Buscar información del pedido en la tabla
            const fila = document.querySelector(`button[data-pedido-id="${idPedido}"]`).closest('tr');
            const cliente = fila.querySelector('td:nth-child(2) strong').textContent;
            const total = fila.querySelector('td:nth-child(4) strong').textContent;
            
            // Actualizar contenido del modal
            document.getElementById('infoPedidoEntrega').innerHTML = `
                <strong>Pedido #${idPedido}</strong><br>
                <small class="text-muted">Cliente: ${cliente}</small><br>
                <small class="text-muted">Total: ${total}</small>
            `;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEntrega'));
            modal.show();
        }

        function mostrarModalCancelacion(idPedido) {
            pedidoActualCancelacion = idPedido;
            
            // Buscar información del pedido en la tabla
            const fila = document.querySelector(`button[data-pedido-id="${idPedido}"]`).closest('tr');
            const cliente = fila.querySelector('td:nth-child(2) strong').textContent;
            const total = fila.querySelector('td:nth-child(4) strong').textContent;
            const estado = fila.querySelector('td:nth-child(6) .badge').textContent.trim();
            
            // Actualizar contenido del modal
            document.getElementById('infoPedidoCancelacion').innerHTML = `
                <strong>Pedido #${idPedido}</strong><br>
                <small class="text-muted">Cliente: ${cliente}</small><br>
                <small class="text-muted">Total: ${total}</small><br>
                <small class="text-muted">Estado actual: ${estado}</small>
            `;
            
            // Limpiar motivo anterior
            document.getElementById('motivoCancelacion').value = '';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalCancelarPedido'));
            modal.show();
        }

        function entregarPedido(idPedido) {
            console.log('Entregando pedido:', idPedido);
            
            // Cerrar modal de confirmación
            const modalConfirmar = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarEntrega'));
            modalConfirmar.hide();
            
            fetch('/pedidos/repartidor/pedidos/' + idPedido + '/entregar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    mostrarNotificacion('success', '¡Éxito!', data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    mostrarNotificacion('error', 'Error', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarNotificacion('error', 'Error de Conexión', 'No se pudo conectar con el servidor. Intentando método alternativo...');
                
                // Fallback: crear un formulario y enviarlo
                setTimeout(() => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/pedidos/repartidor/pedidos/' + idPedido + '/entregar';
                    document.body.appendChild(form);
                    form.submit();
                }, 2000);
            });
        }

        function cancelarPedido(idPedido, motivo) {
            console.log('Cancelando pedido:', idPedido, 'Motivo:', motivo);
            
            // Cerrar modal de cancelación
            const modalCancelar = bootstrap.Modal.getInstance(document.getElementById('modalCancelarPedido'));
            modalCancelar.hide();
            
            fetch('/pedidos/pedidos/' + idPedido + '/cancelar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    motivo: motivo
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    mostrarNotificacion('success', 'Pedido Cancelado', data.message);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    mostrarNotificacion('error', 'Error', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarNotificacion('error', 'Error de Conexión', 'No se pudo conectar con el servidor. Intentando método alternativo...');
                
                // Fallback: crear un formulario y enviarlo
                setTimeout(() => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/pedidos/pedidos/' + idPedido + '/cancelar';
                    
                    // Agregar campo de motivo
                    const inputMotivo = document.createElement('input');
                    inputMotivo.type = 'hidden';
                    inputMotivo.name = 'motivo';
                    inputMotivo.value = motivo;
                    form.appendChild(inputMotivo);
                    
                    document.body.appendChild(form);
                    form.submit();
                }, 2000);
            });
        }

        function mostrarNotificacion(tipo, titulo, mensaje) {
            const modal = document.getElementById('modalNotificacion');
            const header = document.getElementById('headerNotificacion');
            const tituloElement = document.getElementById('tituloNotificacion');
            const iconoElement = document.getElementById('iconoNotificacion');
            const mensajeElement = document.getElementById('mensajeNotificacion');
            
            // Configurar colores y iconos según el tipo
            if (tipo === 'success') {
                header.className = 'modal-header bg-success text-white';
                tituloElement.innerHTML = `<i class="bi bi-check-circle"></i> ${titulo}`;
                iconoElement.className = 'bi bi-check-circle-fill text-success display-1';
            } else if (tipo === 'error') {
                header.className = 'modal-header bg-danger text-white';
                tituloElement.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${titulo}`;
                iconoElement.className = 'bi bi-exclamation-triangle-fill text-danger display-1';
            } else {
                header.className = 'modal-header bg-info text-white';
                tituloElement.innerHTML = `<i class="bi bi-info-circle"></i> ${titulo}`;
                iconoElement.className = 'bi bi-info-circle-fill text-info display-1';
            }
            
            mensajeElement.textContent = mensaje;
            
            // Mostrar modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }

        function verDetalle(idPedido) {
            console.log('Ver detalle pedido:', idPedido);
            
            // Mostrar loading en el modal
            document.getElementById('contenidoDetalle').innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <h6 class="mt-3">Cargando detalles del pedido #${idPedido}</h6>
                    <p class="text-muted">Por favor espera...</p>
                </div>
            `;
            
            // Ocultar botón de nueva ventana
            document.getElementById('btnAbrirEnNuevaVentana').style.display = 'none';
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
            modal.show();
            
            // Cargar contenido del pedido
            fetch('/pedidos/pedido/' + idPedido)
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('Error ' + response.status + ': No se pudo cargar el pedido');
                })
                .then(html => {
                    // Extraer contenido principal del HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Buscar el contenido principal, excluyendo navegación y footer
                    let content = doc.querySelector('.container .row, .container .card, main, .content');
                    
                    if (!content) {
                        // Fallback: buscar cualquier contenedor principal
                        content = doc.querySelector('.container') || doc.body;
                    }
                    
                    // Limpiar el contenido de elementos de navegación
                    const navegacion = content.querySelectorAll('nav, .navbar, .breadcrumb, .btn-group a');
                    navegacion.forEach(el => el.remove());
                    
                    document.getElementById('contenidoDetalle').innerHTML = `
                        <div class="p-4">
                            ${content.innerHTML}
                        </div>
                    `;
                    
                    // Mostrar botón de nueva ventana
                    const btnNuevaVentana = document.getElementById('btnAbrirEnNuevaVentana');
                    btnNuevaVentana.style.display = 'inline-block';
                    btnNuevaVentana.onclick = () => window.open('/pedidos/pedido/' + idPedido, '_blank');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('contenidoDetalle').innerHTML = `
                        <div class="p-4">
                            <div class="alert alert-danger text-center">
                                <i class="bi bi-exclamation-triangle display-1 text-danger mb-3"></i>
                                <h5>Error al cargar el detalle</h5>
                                <p class="mb-3">${error.message}</p>
                                <button class="btn btn-primary" onclick="window.open('/pedidos/pedido/${idPedido}', '_blank')">
                                    <i class="bi bi-box-arrow-up-right"></i> Abrir en nueva ventana
                                </button>
                                <button class="btn btn-secondary ms-2" onclick="verDetalle(${idPedido})">
                                    <i class="bi bi-arrow-clockwise"></i> Reintentar
                                </button>
                            </div>
                        </div>
                    `;
                });
        }
    </script>
</body>
</html>